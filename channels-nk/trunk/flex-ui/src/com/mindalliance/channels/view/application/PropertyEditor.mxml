<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml"
    xmlns:view="com.mindalliance.channels.view.*"
    xmlns:scenario="com.mindalliance.channels.view.scenario.*"
    xmlns:people="com.mindalliance.channels.view.people.*"
    xmlns:resources="com.mindalliance.channels.view.resources.*"
    xmlns:application="com.mindalliance.channels.view.application.*"
    currentState="NothingSelectedState"
    width="100%"
    height="100%">
	<mx:states>
		<mx:State name="TaskNodeEditorState">
			<mx:AddChild position="lastChild">
				<application:TaskNodeEditor id="taskNodeEditor" width="100%" height="100%"/>
			</mx:AddChild>
		</mx:State>
		<mx:State name="RepositoryNodeEditorState">
			<mx:AddChild position="lastChild">
				<application:RepositoryNodeEditor id="repositoryNodeEditor" width="100%" height="100%"/>
			</mx:AddChild>
		</mx:State>
		<mx:State name="NothingSelectedState">
			<mx:SetProperty name="enabled" value="false"/>
			<mx:AddChild position="lastChild">
				<mx:Label text="Nothing Selected"/>
			</mx:AddChild>
		</mx:State>
		<mx:State name="MultipleItemsSelectedState">
			<mx:SetProperty name="enabled" value="false"/>
			<mx:AddChild position="lastChild">
				<mx:Label text="Multiple Items Selected"/>
			</mx:AddChild>
		</mx:State>
		<mx:State name="EventNodeEditorState">
			<mx:AddChild position="lastChild">
				<scenario:EventEditor id="eventEditor" width="100%" height="100%"/>
			</mx:AddChild>
		</mx:State>
		<mx:State name="SharingNeedEditorState">
			<mx:SetProperty name="enabled" value="false"/>
			<mx:AddChild position="lastChild">
				<mx:Label text="Not yet implemented"/>
			</mx:AddChild>

		</mx:State>
	</mx:states>
	
	<mx:Script>
		<![CDATA[
			import mx.binding.utils.BindingUtils;
			import mx.events.StateChangeEvent;
			import com.mindalliance.channels.events.resources.GetRepositoryEvent;
			import com.mindalliance.channels.view.flowmap.RepositoryNodeData;
			import com.mindalliance.channels.events.scenario.GetEventEvent;
			import com.mindalliance.channels.view.flowmap.EventNodeData;
			import com.mindalliance.channels.util.CairngormHelper;
			import com.mindalliance.channels.events.scenario.GetTaskEvent;
			import com.mindalliance.channels.view.flowmap.TaskNodeData;
			import com.mindalliance.channels.view.flowmap.NodeData;
			import com.mindalliance.channels.view.flowmap.GraphMapperHelper;
			import com.mindalliance.channels.view.flowmap.FlowMapEvent;
			import com.yworks.graph.model.SelectionEvent;
			import com.yworks.graph.model.IEdge;
			import com.yworks.graph.model.INode;
			import com.yworks.support.Iterator;
			import com.mindalliance.channels.view.flowmap.FlowMap;
			import com.mindalliance.channels.model.application.PropertyEditorModel;

			[Bindable]
			private var model : PropertyEditorModel;
			
			private var mapperHelper:GraphMapperHelper ;
			
			[Bindable]
			public var isEditing:Boolean ;
		
			public function init():void {
				FlowMap.addSelectionListener(FlowMapEvent.ITEM_SELECTED, itemSelected) ;
				FlowMap.addSelectionListener(FlowMapEvent.ITEM_DESELECTED, itemDeselected) ;
				mapperHelper = GraphMapperHelper.getInstance() ;
				this.addEventListener(StateChangeEvent.CURRENT_STATE_CHANGE, handleStateChange) ;
			}
			
			private function setState(state:String):void {
				isEditing = (state == 'EditState') ;
			}
			
			private function handleStateChange(event:StateChangeEvent):void {
				switch (event.newState) {
					case 'RepositoryNodeEditorState':
						BindingUtils.bindSetter(setState, repositoryNodeEditor, ['editorState']) ;
					break ;
					case 'TaskNodeEditorState':
						BindingUtils.bindSetter(setState, taskNodeEditor, ['editorState']) ;
					break ;
				}
			}
			
			private function itemSelected(event:SelectionEvent):void {
				if (FlowMap.numSelected > 1) {
					currentState = 'MultipleItemsSelectedState' ;
					return ;
				}
				if (event.item is INode) {
					var nodeID:String = FlowMap.getIDForItem(event.item) as String ;
					if (!nodeID)
						return ;
					var nd:NodeData = mapperHelper.nodeDataMapper.lookupValue(nodeID) as NodeData ;
					if (!nd)
						return ;
					if (nd is TaskNodeData) {
						currentState = 'TaskNodeEditorState' ;
						taskNodeEditor.loadTask(TaskNodeData(nd).id) ;
					}
					else if (nd is EventNodeData) {
						currentState = 'EventNodeEditorState' ;
						var getEventEvent:GetEventEvent = new GetEventEvent(EventNodeData(nd).id, eventEditor.model) ;
						CairngormHelper.fireEvent(getEventEvent) ;
					}
					else if (nd is RepositoryNodeData) {
						currentState = 'RepositoryNodeEditorState' ;
						repositoryNodeEditor.loadRepository(RepositoryNodeData(nd).id);
					}
				}
			}
		
			private function itemDeselected(event:SelectionEvent):void {
				if (FlowMap.numSelected == 0)
					currentState = 'NothingSelectedState' ;
				else if (FlowMap.numSelected > 1)
					currentState = 'MultipleItemsSelectedState' ;
			}
			
		]]>
	</mx:Script>
	
</mx:VBox>