<?xml version="1.0" encoding="utf-8"?>
<mx:Form xmlns:mx="http://www.adobe.com/2006/mxml"  
	xmlns:common="com.mindalliance.channels.common.view.*"
    xmlns:scenario="com.mindalliance.channels.scenario.view.*" 
    xmlns:categories="com.mindalliance.channels.categories.view.*"
    creationComplete="init()">
    <mx:Script>
    	<![CDATA[
    	    import com.mindalliance.channels.vo.NeedToKnowVO;
            import com.adobe.cairngorm.control.CairngormEvent;
            import com.mindalliance.channels.util.ViewUtils;
            
            import com.mindalliance.channels.vo.common.*;
            import mx.collections.ArrayCollection;
            import mx.managers.PopUpManager;
            import com.mindalliance.channels.sharingneed.events.*;
            import com.mindalliance.channels.common.events.*;
            
            import com.mindalliance.channels.common.view.InputTextDialog;
            import com.mindalliance.channels.model.EditorModel;
            import com.adobe.cairngorm.control.CairngormEventDispatcher;
            import com.mindalliance.channels.vo.common.ElementVO;
            import com.mindalliance.channels.vo.KnowVO;
            import com.mindalliance.channels.model.ChannelsModelLocator;
            import com.mindalliance.channels.model.ElementModel;
            import com.mindalliance.channels.util.CairngormHelper;
    	
    		[Bindable]
            public function get model() : EditorModel 
            {
                return _editorModel;
            }
            
            public function set model(model : EditorModel) : void 
            {
                this._editorModel = model;
            }
            public var _editorModel : EditorModel = ChannelsModelLocator.getInstance().getEditorModel();
            
            [Bindable]
            private var elementModel : ElementModel;
            
            [Bindable] 
            private var edited : NeedToKnowVO;
            
            private function queueUpdate() : void {
                CairngormHelper.queueUpdate(model);
            }
            
            public function update() : void {
                var updateOnChange : Boolean = false;
                var updateEvery : DurationVO;
                if (cbDeliveryRefresh.selected== true) {
                   var num : Number = Number(textUpdateEveryValue.text);
                   if (num > 0) {
                        updateEvery= new DurationVO(num, comboUpdateEveryUnit.selectedItem.abbr);
                   } else {
                        updateOnChange=true;
                   }
                }
                CairngormHelper.fireEvent(new UpdateNeedToKnowEvent(model,
                                                                subKnowEditor.getWho(),
                                                                subKnowEditor.getAbout(),
                                                                subKnowEditor.getWhat(),
                                                                sliderCriticality.labels[sliderCriticality.value],
                                                                new DurationVO(Number(textUrgency.text), comboScale.selectedItem.abbr),
                                                                comboDeliveryMode.selectedItem.name,
                                                                updateOnChange,
                                                                updateEvery,
                                                                edited.format
                                                                ));
            }
            
            public function init() : void {
                subKnowEditor.model = model;	
            }
            public function revert() : void {
                CairngormHelper.fireEvent(new GetElementEvent(edited.id,model));
                    
            }
            
            public function getSliderValue(val : String) : int {
                switch (val) {	
                	case 'low' : return 0;
                	case 'medium' : return 1;
                	case 'high' : return 2;
                }
                return -1;
            }
            
    	]]>
    </mx:Script>
    
    <mx:Array id="deliveryMode">
        <mx:Object label="Notify" name="notify"/>
        <mx:Object label="Respond" name="respond"/>
    </mx:Array>
    
    <mx:Array id="format">
        <mx:Object label="Hard Copy (Paper)"/>
        <mx:Object label="MS Word Document"/>
        <mx:Object label="PDF"/>
        <mx:Object label="Audio"/>
        <mx:Object label="Video"/>
    </mx:Array>
    
    <mx:Binding source="model.getElementModel(model.id)" destination="elementModel"/>
    <mx:Binding source="(elementModel.data as NeedToKnowVO)" destination="edited"/>   
    <mx:Binding source="edited.format" destination="categoryViewer.model.categories"/>
    <mx:states>
    	<mx:State name="EditState">
    		
            <mx:SetProperty target="{formItemUrgency}" name="mouseChildren"/>
            <mx:SetProperty target="{formItemUrgency}" name="mouseEnabled"/>
            <mx:SetProperty target="{textUrgency}" name="editable" value="true"/>
            <mx:SetProperty target="{formItemCriticality}" name="mouseChildren"/>
            <mx:SetProperty target="{formItemCriticality}" name="mouseEnabled"/>
            <mx:SetProperty target="{formItemDelivery}" name="mouseChildren"/>
            <mx:SetProperty target="{formItemDelivery}" name="mouseEnabled"/>
            <mx:SetProperty target="{textUpdateEveryValue}" name="editable" value="true"/>
    	</mx:State>
    	
    </mx:states>
	<scenario:KnowingEditor id="subKnowEditor" currentState="{currentState}"/>
    <mx:Form>
        <mx:FormItem id="formItemCriticality" label="Criticality" mouseChildren="false" mouseEnabled="false">
            <mx:HSlider id="sliderCriticality" labels="['low', 'medium', 'high']" showDataTip="false" showTrackHighlight="true"
                minimum="0" maximum="2" snapInterval="1" allowTrackClick="true" change="queueUpdate()" value="{getSliderValue(edited.criticality)}"/>
        </mx:FormItem>
        <mx:FormItem id="formItemUrgency" label="Urgency" direction="horizontal" mouseChildren="false" mouseEnabled="false">
            <mx:TextInput id="textUrgency" editable="false" width="50"  text="{edited.urgency.value}"/><common:TimeScalesComboBox id="comboScale" selectedValue="{edited.urgency.unit}"  change="queueUpdate()"/>
        </mx:FormItem>
        <mx:FormItem id="formItemDelivery" label="Delivery" direction="horizontal" mouseChildren="false" mouseEnabled="false">
            <common:ElementComboBox id="comboDeliveryMode" dataProvider="{deliveryMode}" selectedValue="{edited.deliveryMode}" labelField="label" dataField="name"  change="queueUpdate()"/>
            <mx:HBox verticalAlign="middle" height="100%">
                <mx:CheckBox label="Refresh" id="cbDeliveryRefresh" selected="{edited.updateOnChange == true || edited.updateEvery != null}"  change="queueUpdate()"/>
                <mx:HBox includeInLayout="{cbDeliveryRefresh.selected}" visible="{cbDeliveryRefresh.selected}" verticalAlign="middle">
                    <mx:Label text="every"/><mx:TextInput id="textUpdateEveryValue" editable="false" text="{edited.updateEvery.value}" width="50" change="queueUpdate()"/><common:TimeScalesComboBox id="comboUpdateEveryUnit" selectedValue="{edited.updateEvery.unit}"  change="queueUpdate()"/>
                </mx:HBox>
            </mx:HBox>
        </mx:FormItem>
        <mx:FormItem label="Format">
            <!--<mx:ComboBox dataProvider="{format}"/>-->
            <categories:CategoryViewer id="categoryViewer" currentState="{currentState}" change="{queueUpdate}"/>
        </mx:FormItem>
    </mx:Form>
</mx:Form>
