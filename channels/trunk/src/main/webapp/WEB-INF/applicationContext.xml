<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context-2.5.xsd">

    <bean id="queryService" class="com.mindalliance.channels.query.DefaultQueryService">
        <property name="addingSamples" value="false"/>
        <property name="importingScenarios" value="true"/>
        <property name="importDirectory" value="target/import"/>
        <property name="dao" ref="dao"/>
    </bean>
    <bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
        <property name="targetObject" ref="queryService"/>
        <property name="targetMethod" value="addObserver"/>
        <property name="arguments">
            <list value-type="java.util.Observer"><ref bean="attachmentManager"/></list>
        </property>
    </bean>

    <bean id="serializer" class="com.mindalliance.channels.export.xml.XmlStreamer">
        <property name="version" value="1.0"/>
    </bean>

    <bean id="attachmentManager" class="com.mindalliance.channels.attachments.FileBasedManager"
          init-method="start" destroy-method="stop">
        <property name="directory" value="target/channels-1.0-SNAPSHOT/uploads"/>
        <property name="path" value="uploads/"/>
    </bean>

    <!-- setup wicket application -->
    <bean id="wicketApplication" class="com.mindalliance.channels.Channels">
        <property name="attachmentManager" ref="attachmentManager"/>
        <property name="importer" ref="serializer"/>
        <property name="exporter" ref="serializer"/>
        <property name="analyst" ref="analyst"/>
        <property name="queryService" ref="queryService"/>
        <property name="plans">
            <list value-type="java.util.ArrayList">
                <bean class="com.mindalliance.channels.model.Plan">
                    <property name="uri" value="mindalliance.com/channels/demo"/>
                    <property name="name" value="SCI Emergency Communications Plan"/>
                    <property name="client" value="Strategic Content Imaging, Inc."/>
                    <property name="description"
                              value="Communications planning for responding and recovering from business interruptions due fire or power outage."/>
                    <property name="events">
                        <list value-type="java.util.ArrayList">
                            <bean class="com.mindalliance.channels.model.PlanEvent">
                                <property name="name" value="fire"/>
                            </bean>
                            <bean class="com.mindalliance.channels.model.PlanEvent">
                                <property name="name" value="power outage"/>
                            </bean>
                        </list>
                    </property>
                </bean>
            </list>
        </property>
    </bean>

    <!-- Flow diagram factory : a prototype -->
    <bean id="diagramFactory" class="com.mindalliance.channels.graph.DefaultDiagramFactory" scope="prototype">
        <property name="graphRenderer" ref="graphvizRenderer"/>
        <property name="imageDirectory" value="src/site/resources/images"/>
        <property name="queryService" ref="queryService"/>
    </bean>

    <bean id="graphvizRenderer" class="com.mindalliance.channels.graph.GraphvizRenderer">
        <property name="dotPath" value="/usr/bin"/>
        <property name="algo" value="dot"/>
        <property name="timeout" value="10000"/>
    </bean>

    <!-- Scenario analyst -->
    <bean id="analyst" class="com.mindalliance.channels.analysis.DefaultAnalyst">
        <property name="issueDetectors">
            <list value-type="java.util.ArrayList">
                <bean class="com.mindalliance.channels.analysis.detectors.FromUser">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.StartedOrTerminatedPartWithoutTask">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.PartWithoutRole">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.FlowWithoutChannel">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.InvalidChannel">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.UnnamedFlow"/>
                <bean class="com.mindalliance.channels.analysis.detectors.FlowWithUndefinedSource">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.FlowWithUndefinedTarget">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.PartWithInvalidTiming">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.OrphanedPart">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.RedundantPart">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.RedundantFlow">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.UnconnectedConnector">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.FlowViolatesPolicy">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.UnconfirmedJob">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.FlowToSelf">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.PartWithRoleWithNoKnownActor">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.ScenarioNeverTerminates">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.TriggeredButNeverStartedDefinedTask">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.NeverTriggeredSpecifiedTask">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.AutoStartPartAlsoTriggered">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.NonIncidentScenarioNeverInitiated">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.InitiatedScenarioNeverStarted">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.CyclicTriggering">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.NoRedundancy">
                    <property name="queryService" ref="queryService"/>
                </bean>
                <bean class="com.mindalliance.channels.analysis.detectors.PotentialDeadlock">
                    <property name="queryService" ref="queryService"/>
                </bean>
            </list>
        </property>
    </bean>

    <!-- Lock manager -->
    <bean id="lockManager" class="com.mindalliance.channels.command.DefaultLockManager" scope="prototype">
        <property name="queryService" ref="queryService"/>
    </bean>

    <!-- Commander -->
    <bean id="commander" class="com.mindalliance.channels.command.DefaultCommander" scope="prototype">
        <property name="timeout" value="300"/>
        <property name="queryService" ref="queryService"/>
    </bean>

</beans>
